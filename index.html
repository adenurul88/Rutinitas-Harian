<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rutinitas Harian</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f3f4f6;
}
header {
  background: #4f46e5;
  color: white;
  padding: 16px;
  text-align: center;
}
.section {
  background: white;
  margin: 12px;
  padding: 12px;
  border-radius: 10px;
}
.routine h3 {
  margin: 0;
}
.check {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 6px 0;
}
.done {
  color: green;
  font-weight: bold;
}
img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 6px;
}
button {
  margin-top: 6px;
  padding: 6px 10px;
}
.history-item {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
}
</style>
</head>

<body>

<header>
  <h1>Rutinitas Harian</h1>
  <p id="today"></p>
</header>

<div id="routines"></div>

<div class="section">
  <button onclick="showHistory()">Lihat Riwayat</button>
  <button onclick="exportPDF()">Export PDF Hari Ini</button>
  <div id="history"></div>
</div>

<script>
const routines = [
  {name:"Mandi Pagi", time:"04:30"},
  {name:"Shalat Subuh", time:"04:55"},
  {name:"Dzikir Pagi", time:"05:05"},
  {name:"Sapu & Pel Rumah", time:"05:15"},
  {name:"Olahraga 15 Menit", time:"06:30"},
  {name:"Duolingo Matematika", time:"07:30"},
  {name:"Duolingo Bahasa Inggris", time:"08:00"},
  {name:"Shalat Dzuhur", time:"12:15"},
  {name:"Kajian", time:"12:45"},
  {name:"Baca Buku Target", time:"14:00"},
  {name:"Shalat Ashar", time:"15:35"},
  {name:"Dzikir Petang", time:"15:45"},
  {name:"Mandi Sore", time:"17:00"},
  {name:"Shalat Maghrib", time:"18:10"},
  {name:"Shalat Isya", time:"19:25"},
  {name:"Tidur", time:"22:00"}
];

const today = new Date().toISOString().slice(0,10);
document.getElementById("today").innerText = "Tanggal: " + today;

function load(){
  const data = JSON.parse(localStorage.getItem("data") || "{}");
  const container = document.getElementById("routines");
  container.innerHTML = "";

  routines.forEach((r,i)=>{
    const key = today+"-"+i;
    const entry = data[key] || {};
    const div = document.createElement("div");
    div.className = "section routine";

    div.innerHTML = `
      <h3>${r.time} - ${r.name}</h3>

      <div class="check">
        <input type="checkbox" ${entry.done ? "checked" : ""} 
          onchange="toggleDone('${key}',this.checked)">
        <span class="${entry.done ? "done" : ""}">
          ${entry.done ? "Selesai ("+entry.doneTime+")" : "Belum dilakukan"}
        </span>
      </div>

      <input type="file" accept="image/*" onchange="saveImage(event,'${key}')">

      ${entry.img ? `
        <p>Upload: ${entry.uploadTime}</p>
        <img src="${entry.img}">
        <br>
        <button onclick="remove('${key}')">Hapus</button>
      ` : ""}
    `;
    container.appendChild(div);
  });
}

function toggleDone(key,val){
  const data = JSON.parse(localStorage.getItem("data") || "{}");
  if(!data[key]) data[key] = {};
  data[key].done = val;
  data[key].doneTime = val ? new Date().toLocaleTimeString() : "";
  localStorage.setItem("data",JSON.stringify(data));
  load();
}

function saveImage(e,key){
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ()=>{
    const data = JSON.parse(localStorage.getItem("data") || "{}");
    if(!data[key]) data[key] = {};
    data[key].img = reader.result;
    data[key].uploadTime = new Date().toLocaleTimeString();
    localStorage.setItem("data",JSON.stringify(data));
    load();
  };
  reader.readAsDataURL(file);
}

function remove(key){
  const data = JSON.parse(localStorage.getItem("data") || "{}");
  delete data[key];
  localStorage.setItem("data",JSON.stringify(data));
  load();
}

function showHistory(){
  const data = JSON.parse(localStorage.getItem("data") || "{}");
  const h = document.getElementById("history");
  h.innerHTML = "<h3>Riwayat</h3>";

  Object.keys(data).forEach(k=>{
    const d = document.createElement("div");
    d.className="history-item";
    d.innerText = k + " | " + (data[k].done ? "✔" : "✘");
    h.appendChild(d);
  });
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const data = JSON.parse(localStorage.getItem("data") || {});
  let y = 10;

  pdf.text("Rekap Rutinitas - " + today, 10, y);
  y += 10;

  routines.forEach((r,i)=>{
    const key = today+"-"+i;
    const e = data[key];
    const status = e?.done ? "Selesai ("+e.doneTime+")" : "Belum";
    pdf.text(`${r.time} - ${r.name} : ${status}`, 10, y);
    y += 8;
    if(y > 280){ pdf.addPage(); y = 10; }
  });

  pdf.save("rutinitas-"+today+".pdf");
}

load();

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>